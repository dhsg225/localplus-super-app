#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# [2024-07-29] - Pre-commit hook to prevent common development issues
# This hook catches problems before they're committed to the repository

echo "ğŸ” Running pre-commit checks..."

# 1. Check for JSX syntax in .js files (common cause of build failures)
echo "ğŸ“ Checking for JSX in .js files..."
if find src/ partner/src/ admin/src/ -name "*.js" -exec grep -l "<[A-Z]" {} \; 2>/dev/null | grep -q .; then
    echo "âŒ Found JSX syntax in .js files. These should be renamed to .jsx:"
    find src/ partner/src/ admin/src/ -name "*.js" -exec grep -l "<[A-Z]" {} \; 2>/dev/null
    echo ""
    echo "ğŸ”§ Fix by renaming these files to .jsx extension"
    exit 1
fi

# 2. Check for missing environment files
echo "ğŸ”‘ Checking environment files..."
if [ ! -f .env ] && [ ! -f env.example ]; then
    echo "âŒ No .env or env.example file found in root directory"
    echo "ğŸ”§ Create env.example with required environment variables"
    exit 1
fi

if [ ! -f partner/.env ] && [ ! -f partner/env.example ]; then
    echo "âŒ No .env or env.example file found in partner directory"
    echo "ğŸ”§ Create partner/env.example with required environment variables"
    exit 1
fi

# 3. Check for invalid UUID formats in mock data
echo "ğŸ†” Checking for invalid UUID formats in mock data..."
if grep -r "mock-[a-z]*-[0-9]*" shared/services/ --include="*.ts" --include="*.js" 2>/dev/null | grep -q .; then
    echo "âŒ Found invalid UUID formats in mock data:"
    grep -r "mock-[a-z]*-[0-9]*" shared/services/ --include="*.ts" --include="*.js" 2>/dev/null
    echo ""
    echo "ğŸ”§ Fix by using valid UUID format: 550e8400-e29b-41d4-a716-446655440000"
    exit 1
fi

# 4. Check for common environment variable issues (skip .d.ts files)
echo "ğŸŒ Checking environment variable patterns..."
if find shared/services/ -name "*.ts" -o -name "*.js" | grep -v "\.d\.ts" | xargs grep "VITE_SUPABASE_URL" 2>/dev/null | grep -v "import.meta.env" | grep -v "VITE_SUPABASE_URL\?:" | grep -q .; then
    echo "âŒ Found hardcoded Supabase URLs. Use environment variables instead:"
    find shared/services/ -name "*.ts" -o -name "*.js" | grep -v "\.d\.ts" | xargs grep "VITE_SUPABASE_URL" 2>/dev/null | grep -v "import.meta.env" | grep -v "VITE_SUPABASE_URL\?:"
    echo ""
    echo "ğŸ”§ Use import.meta.env.VITE_SUPABASE_URL instead of hardcoded values"
    exit 1
fi

# 5. Check for proper file extensions in imports (skip library imports)
echo "ğŸ“¦ Checking import statements for proper file extensions..."
if grep -r "from.*\.js['\"]" src/ partner/src/ admin/src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null | grep -v "\.jsx" | grep -v "chart\.js" | grep -v "node_modules" | grep -q .; then
    echo "âŒ Found imports from .js files that should be .jsx:"
    grep -r "from.*\.js['\"]" src/ partner/src/ admin/src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null | grep -v "\.jsx" | grep -v "chart\.js" | grep -v "node_modules"
    echo ""
    echo "ğŸ”§ Update imports to use .jsx extension for JSX files"
    exit 1
fi

# 6. Check for useToast context issues (allow proper usage patterns)
echo "ğŸ Checking for useToast context issues..."
if grep -r "useToast()" src/ partner/src/ admin/src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null | grep -v "const.*useToast" | grep -v "var.*useToast" | grep -q .; then
    echo "âŒ Found potential useToast context issues:"
    grep -r "useToast()" src/ partner/src/ admin/src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null | grep -v "const.*useToast" | grep -v "var.*useToast"
    echo ""
    echo "ğŸ”§ Ensure useToast is called within ToastProvider context"
    exit 1
fi

# 7. Check for proper TypeScript interface usage
echo "ğŸ“ Checking TypeScript interface compliance..."
if grep -r "website:" shared/services/ --include="*.ts" --include="*.js" 2>/dev/null | grep -q .; then
    echo "âŒ Found 'website' property that should be 'website_url':"
    grep -r "website:" shared/services/ --include="*.ts" --include="*.js" 2>/dev/null
    echo ""
    echo "ğŸ”§ Use 'website_url' to match Restaurant interface"
    exit 1
fi

echo "âœ… All pre-commit checks passed!"
echo "ï¿½ï¿½ Ready to commit!"
